-- Create API_USERS table for JWT authentication
-- This table stores user credentials and account information

CREATE TABLE API_USERS (
    USER_ID NUMBER(38,0) GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    USERNAME VARCHAR2(50) NOT NULL UNIQUE,
    PASSWORD_HASH VARCHAR2(255) NOT NULL,
    EMAIL VARCHAR2(100),
    FULL_NAME VARCHAR2(100),
    IS_ACTIVE NUMBER(1) DEFAULT 1 NOT NULL,
    IS_ADMIN NUMBER(1) DEFAULT 0 NOT NULL,
    CREATED_DATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
    LAST_LOGIN TIMESTAMP,
    FAILED_LOGIN_ATTEMPTS NUMBER(3) DEFAULT 0,
    LOCKED_UNTIL TIMESTAMP
);

-- Create indexes for fast lookups
CREATE INDEX IDX_API_USERS_USERNAME ON API_USERS(USERNAME);
CREATE INDEX IDX_API_USERS_EMAIL ON API_USERS(EMAIL);

-- Add comments for documentation
COMMENT ON TABLE API_USERS IS 'Stores API user accounts for JWT authentication';
COMMENT ON COLUMN API_USERS.USER_ID IS 'Primary key, auto-generated';
COMMENT ON COLUMN API_USERS.USERNAME IS 'Unique username for login';
COMMENT ON COLUMN API_USERS.PASSWORD_HASH IS 'Bcrypt hashed password (never plain text)';
COMMENT ON COLUMN API_USERS.EMAIL IS 'User email address';
COMMENT ON COLUMN API_USERS.FULL_NAME IS 'User full name';
COMMENT ON COLUMN API_USERS.IS_ACTIVE IS 'Account active status (1=active, 0=inactive)';
COMMENT ON COLUMN API_USERS.IS_ADMIN IS 'Admin flag (1=admin, 0=user)';
COMMENT ON COLUMN API_USERS.CREATED_DATE IS 'Account creation timestamp';
COMMENT ON COLUMN API_USERS.LAST_LOGIN IS 'Last successful login timestamp';
COMMENT ON COLUMN API_USERS.FAILED_LOGIN_ATTEMPTS IS 'Counter for failed login attempts';
COMMENT ON COLUMN API_USERS.LOCKED_UNTIL IS 'Account lock expiration timestamp';

-- Create API_USER_ROLES table for role-based access control
CREATE TABLE API_USER_ROLES (
    USER_ROLE_ID NUMBER(38,0) GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    USER_ID NUMBER(38,0) NOT NULL,
    ROLE_NAME VARCHAR2(50) NOT NULL,
    CREATED_DATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
    FOREIGN KEY (USER_ID) REFERENCES API_USERS(USER_ID) ON DELETE CASCADE
);

-- Create indexes for API_USER_ROLES
CREATE INDEX IDX_API_USER_ROLES_USER_ID ON API_USER_ROLES(USER_ID);
CREATE INDEX IDX_API_USER_ROLES_ROLE_NAME ON API_USER_ROLES(ROLE_NAME);

-- Add comments for API_USER_ROLES
COMMENT ON TABLE API_USER_ROLES IS 'Stores user roles for role-based access control';
COMMENT ON COLUMN API_USER_ROLES.USER_ROLE_ID IS 'Primary key, auto-generated';
COMMENT ON COLUMN API_USER_ROLES.USER_ID IS 'Foreign key to API_USERS.USER_ID';
COMMENT ON COLUMN API_USER_ROLES.ROLE_NAME IS 'Role name (e.g., ADMIN, USER)';
COMMENT ON COLUMN API_USER_ROLES.CREATED_DATE IS 'Role assignment timestamp';


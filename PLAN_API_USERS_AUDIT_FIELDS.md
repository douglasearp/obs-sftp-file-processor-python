# Plan: Add Audit Fields to API_USERS Table

## Overview

Add audit tracking fields to the `API_USERS` table to track who created and updated records, and when.

## Required Fields

- `CREATED_BY_USER` - User who created the record
- `CREATED_DATE` - Timestamp when record was created (already exists)
- `UPDATED_BY_USER` - User who last updated the record
- `UPDATED_DATE` - Timestamp when record was last updated

## Current Table Structure

Based on `database/create_api_users_tables.sql`, the current `API_USERS` table has:

```sql
CREATE TABLE API_USERS (
    USER_ID NUMBER(38,0) GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    USERNAME VARCHAR2(50) NOT NULL UNIQUE,
    PASSWORD_HASH VARCHAR2(255) NOT NULL,
    EMAIL VARCHAR2(100),
    FULL_NAME VARCHAR2(100),
    IS_ACTIVE NUMBER(1) DEFAULT 1 NOT NULL,
    IS_ADMIN NUMBER(1) DEFAULT 0 NOT NULL,
    CREATED_DATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,  -- ✅ Already exists
    LAST_LOGIN TIMESTAMP,
    FAILED_LOGIN_ATTEMPTS NUMBER(3) DEFAULT 0,
    LOCKED_UNTIL TIMESTAMP
);
```

## Fields Status

- ✅ `CREATED_DATE` - Already exists (TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL)
- ❌ `CREATED_BY_USER` - **Missing** - Need to add
- ❌ `UPDATED_BY_USER` - **Missing** - Need to add
- ❌ `UPDATED_DATE` - **Missing** - Need to add

## SQL ALTER Statements

### Add Missing Columns

```sql
-- Add CREATED_BY_USER column
ALTER TABLE API_USERS
ADD CREATED_BY_USER VARCHAR2(50);

-- Add UPDATED_BY_USER column
ALTER TABLE API_USERS
ADD UPDATED_BY_USER VARCHAR2(50);

-- Add UPDATED_DATE column
ALTER TABLE API_USERS
ADD UPDATED_DATE TIMESTAMP;
```

### Add Comments for Documentation

```sql
COMMENT ON COLUMN API_USERS.CREATED_BY_USER IS 'User who created the record';
COMMENT ON COLUMN API_USERS.UPDATED_BY_USER IS 'User who last updated the record';
COMMENT ON COLUMN API_USERS.UPDATED_DATE IS 'Timestamp when record was last updated';
```

### Optional: Add Indexes (if needed for queries)

```sql
-- Index on CREATED_BY_USER (if you need to query by creator)
CREATE INDEX IDX_API_USERS_CREATED_BY_USER ON API_USERS(CREATED_BY_USER);

-- Index on UPDATED_BY_USER (if you need to query by updater)
CREATE INDEX IDX_API_USERS_UPDATED_BY_USER ON API_USERS(UPDATED_BY_USER);

-- Index on UPDATED_DATE (if you need to query by update date)
CREATE INDEX IDX_API_USERS_UPDATED_DATE ON API_USERS(UPDATED_DATE);
```

## Complete SQL Script

Create file: `database/alter_api_users_add_audit_fields.sql`

```sql
-- Add audit fields to API_USERS table
-- This script adds CREATED_BY_USER, UPDATED_BY_USER, and UPDATED_DATE columns

-- Check if columns already exist (Oracle 12c+)
-- If columns exist, these statements will fail gracefully

-- Add CREATED_BY_USER column
ALTER TABLE API_USERS
ADD CREATED_BY_USER VARCHAR2(50);

-- Add UPDATED_BY_USER column
ALTER TABLE API_USERS
ADD UPDATED_BY_USER VARCHAR2(50);

-- Add UPDATED_DATE column
ALTER TABLE API_USERS
ADD UPDATED_DATE TIMESTAMP;

-- Add comments for documentation
COMMENT ON COLUMN API_USERS.CREATED_BY_USER IS 'User who created the record';
COMMENT ON COLUMN API_USERS.UPDATED_BY_USER IS 'User who last updated the record';
COMMENT ON COLUMN API_USERS.UPDATED_DATE IS 'Timestamp when record was last updated';

-- Optional: Add indexes for better query performance
-- Uncomment if you need to query by these fields frequently

-- CREATE INDEX IDX_API_USERS_CREATED_BY_USER ON API_USERS(CREATED_BY_USER);
-- CREATE INDEX IDX_API_USERS_UPDATED_BY_USER ON API_USERS(UPDATED_BY_USER);
-- CREATE INDEX IDX_API_USERS_UPDATED_DATE ON API_USERS(UPDATED_DATE);

-- Verify the changes
SELECT 
    COLUMN_NAME,
    DATA_TYPE,
    DATA_LENGTH,
    NULLABLE,
    DATA_DEFAULT
FROM USER_TAB_COLUMNS
WHERE TABLE_NAME = 'API_USERS'
  AND COLUMN_NAME IN ('CREATED_BY_USER', 'CREATED_DATE', 'UPDATED_BY_USER', 'UPDATED_DATE')
ORDER BY COLUMN_NAME;
```

## Updated Table Structure (After ALTER)

```sql
CREATE TABLE API_USERS (
    USER_ID NUMBER(38,0) GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    USERNAME VARCHAR2(50) NOT NULL UNIQUE,
    PASSWORD_HASH VARCHAR2(255) NOT NULL,
    EMAIL VARCHAR2(100),
    FULL_NAME VARCHAR2(100),
    IS_ACTIVE NUMBER(1) DEFAULT 1 NOT NULL,
    IS_ADMIN NUMBER(1) DEFAULT 0 NOT NULL,
    CREATED_BY_USER VARCHAR2(50),              -- ✅ NEW
    CREATED_DATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
    UPDATED_BY_USER VARCHAR2(50),              -- ✅ NEW
    UPDATED_DATE TIMESTAMP,                    -- ✅ NEW
    LAST_LOGIN TIMESTAMP,
    FAILED_LOGIN_ATTEMPTS NUMBER(3) DEFAULT 0,
    LOCKED_UNTIL TIMESTAMP
);
```

## Code Updates Required

After adding these fields to the database, update the following files:

### 1. Update `api_users_models.py`

Add fields to `ApiUserBase` and `ApiUserResponse`:

```python
class ApiUserBase(BaseModel):
    """Base model for API_USERS table."""
    
    username: str = Field(..., max_length=50, description="Unique username for login")
    email: Optional[str] = Field(None, max_length=100, description="User email address")
    full_name: Optional[str] = Field(None, max_length=100, description="User full name")
    is_active: int = Field(1, description="Account active status (1=active, 0=inactive)")
    is_admin: int = Field(0, description="Admin flag (1=admin, 0=user)")
    created_by_user: Optional[str] = Field(None, max_length=50, description="User who created the record")  # NEW
    updated_by_user: Optional[str] = Field(None, max_length=50, description="User who last updated the record")  # NEW

class ApiUserResponse(BaseModel):
    """Response model for API_USERS API."""
    
    user_id: int
    username: str
    email: Optional[str] = None
    full_name: Optional[str] = None
    is_active: int
    is_admin: int
    created_by_user: Optional[str] = None  # NEW
    created_date: datetime
    updated_by_user: Optional[str] = None  # NEW
    updated_date: Optional[datetime] = None  # NEW
    last_login: Optional[datetime] = None
    failed_login_attempts: int = 0
    locked_until: Optional[datetime] = None
```

### 2. Update `ApiUserCreate` Model

Add `created_by_user` field:

```python
class ApiUserCreate(ApiUserBase):
    """Model for creating API_USERS records."""
    
    password: str = Field(..., description="Plain text password (will be hashed with bcrypt)")
    created_by_user: str = Field(..., max_length=50, description="User who created the record")  # NEW - Required on create
```

### 3. Update `ApiUserUpdate` Model

Add `updated_by_user` field:

```python
class ApiUserUpdate(BaseModel):
    """Model for updating API_USERS records."""
    
    username: Optional[str] = Field(None, max_length=50, description="Unique username for login")
    email: Optional[str] = Field(None, max_length=100, description="User email address")
    full_name: Optional[str] = Field(None, max_length=100, description="User full name")
    password: Optional[str] = Field(None, description="Plain text password (will be hashed with bcrypt if provided)")
    is_active: Optional[int] = Field(None, description="Account active status (1=active, 0=inactive)")
    is_admin: Optional[int] = Field(None, description="Admin flag (1=admin, 0=user)")
    updated_by_user: Optional[str] = Field(None, max_length=50, description="User who updated the record")  # NEW
```

### 4. Update `oracle_service.py` - `create_api_user()` Method

Add `CREATED_BY_USER` to INSERT:

```python
def create_api_user(self, user: ApiUserCreate) -> int:
    """Create a new API_USERS record with bcrypt password hashing."""
    try:
        # Hash password using bcrypt (same logic as authenticate_user)
        password_bytes = user.password.encode('utf-8')
        password_hash = bcrypt.hashpw(password_bytes, bcrypt.gensalt(rounds=12)).decode('utf-8')
        
        with self.get_connection() as conn:
            cursor = conn.cursor()
            
            insert_sql = f"""
            INSERT INTO {self.config.db_schema}.API_USERS (
                USERNAME,
                PASSWORD_HASH,
                EMAIL,
                FULL_NAME,
                IS_ACTIVE,
                IS_ADMIN,
                CREATED_BY_USER,  -- NEW
                CREATED_DATE
            ) VALUES (
                :username,
                :password_hash,
                :email,
                :full_name,
                :is_active,
                :is_admin,
                :created_by_user,  -- NEW
                CURRENT_TIMESTAMP
            ) RETURNING USER_ID INTO :user_id
            """
            
            user_id = cursor.var(int)
            cursor.execute(insert_sql, {
                'username': user.username,
                'password_hash': password_hash,
                'email': user.email,
                'full_name': user.full_name,
                'is_active': user.is_active,
                'is_admin': user.is_admin,
                'created_by_user': user.created_by_user,  -- NEW
                'user_id': user_id
            })
            # ... rest of method
```

### 5. Update `oracle_service.py` - `get_api_user()` Method

Add fields to SELECT:

```python
select_sql = f"""
SELECT 
    USER_ID,
    USERNAME,
    EMAIL,
    FULL_NAME,
    IS_ACTIVE,
    IS_ADMIN,
    CREATED_BY_USER,  -- NEW
    CREATED_DATE,
    UPDATED_BY_USER,  -- NEW
    UPDATED_DATE,     -- NEW
    LAST_LOGIN,
    FAILED_LOGIN_ATTEMPTS,
    LOCKED_UNTIL
FROM {self.config.db_schema}.API_USERS
WHERE USER_ID = :user_id
"""
```

### 6. Update `oracle_service.py` - `get_api_users()` Method

Add fields to SELECT:

```python
select_sql = f"""
SELECT 
    USER_ID,
    USERNAME,
    EMAIL,
    FULL_NAME,
    IS_ACTIVE,
    IS_ADMIN,
    CREATED_BY_USER,  -- NEW
    CREATED_DATE,
    UPDATED_BY_USER,  -- NEW
    UPDATED_DATE,     -- NEW
    LAST_LOGIN,
    FAILED_LOGIN_ATTEMPTS,
    LOCKED_UNTIL
FROM {self.config.db_schema}.API_USERS
WHERE {where_clause}
ORDER BY USERNAME
OFFSET :offset ROWS FETCH NEXT :limit ROWS ONLY
"""
```

### 7. Update `oracle_service.py` - `update_api_user()` Method

Add `UPDATED_BY_USER` and `UPDATED_DATE` to UPDATE:

```python
def update_api_user(self, user_id: int, user: ApiUserUpdate) -> bool:
    """Update an API_USERS record. Password will be hashed if provided."""
    try:
        with self.get_connection() as conn:
            cursor = conn.cursor()
            
            # Build UPDATE fields dynamically
            update_fields = []
            params = {'user_id': user_id}
            
            # ... existing field updates ...
            
            # Always update UPDATED_DATE and UPDATED_BY_USER
            update_fields.append("UPDATED_DATE = CURRENT_TIMESTAMP")
            if user.updated_by_user:
                update_fields.append("UPDATED_BY_USER = :updated_by_user")
                params['updated_by_user'] = user.updated_by_user
            
            # ... rest of method
```

## Implementation Checklist

- [ ] Run SQL ALTER statements to add columns to database
- [ ] Update `api_users_models.py` - Add fields to models
- [ ] Update `oracle_service.py` - Add fields to INSERT/SELECT/UPDATE queries
- [ ] Update `main.py` - Ensure endpoints pass audit fields
- [ ] Test CREATE operation with `created_by_user`
- [ ] Test UPDATE operation with `updated_by_user` and `updated_date`
- [ ] Verify fields appear in API responses
- [ ] Update Swagger documentation (auto-generated)

## Notes

- `CREATED_DATE` already exists with `DEFAULT CURRENT_TIMESTAMP`, so no changes needed
- `CREATED_BY_USER` should be required on CREATE
- `UPDATED_BY_USER` and `UPDATED_DATE` should be set on every UPDATE
- All audit fields are nullable to support existing records
- Consider adding a trigger to auto-set `UPDATED_DATE` on UPDATE (optional)

